
* Unitime 2.0

  This is the new Unitime 2.0 branch.

  Work is in progress.

* Development environment

  Dont beleve everything in this docuement. BUT the project is running docker. So to start
  the environment use

  #+BEGIN_SRC shell
    docker-compose up
  #+END_SRC

  See example of usage [[restclient][below]] in Restclient.

* Restclient
  <<restclient>>


  #+BEGIN_SRC restclient
    GET http://localhost:8000/api/course/
    User-Agent: Emacs Restclient
    Content-Type: application/json

    {
        "course": "1PE502"
    }
  #+END_SRC

  #+RESULTS:
  #+BEGIN_SRC js
  {
    "code": "1PE502",
    "name": "Pedagogical and professional leadership",
    "speed": "50%",
    "points": "15 hp",
    "syllabus": "http://api.kursinfo.lnu.se/GenerateDocument.ashx?templatetype=coursesyllabus&code=1PE502&documenttype=pdf&lang=en"
  }
  // GET http://localhost:8000/api/course/
  // HTTP/1.1 200 OK
  // Date: Fri, 19 Jan 2018 21:23:52 GMT
  // Server: WSGIServer/0.2 CPython/3.6.3
  // Content-Type: application/json
  // Vary: Accept, Cookie
  // Allow: GET, HEAD, OPTIONS
  // X-Frame-Options: SAMEORIGIN
  // Content-Length: 233
  // Request duration: 0.013369s
  #+END_SRC

  #+BEGIN_SRC restclient
    GET http://localhost:8000/api/lectures/
    User-Agent: Emacs Restclient
    Content-Type: application/json

    {
        "course": "1PE502"
    }
  #+END_SRC

  #+RESULTS:
  #+BEGIN_SRC js
  []
  // GET http://localhost:8000/api/lectures/
  // HTTP/1.1 200 OK
  // Date: Fri, 19 Jan 2018 21:35:00 GMT
  // Server: WSGIServer/0.2 CPython/3.6.3
  // Content-Type: application/json
  // Vary: Accept, Cookie
  // Allow: GET, HEAD, OPTIONS
  // X-Frame-Options: SAMEORIGIN
  // Content-Length: 2
  // Request duration: 0.053959s
  #+END_SRC

* Stuff

#+BEGIN_SRC shell
docker-compose up
#+END_SRC

Enter the env

#+BEGIN_SRC shell
docker exec -it celpython bash
#+END_SRC

start celery

#+BEGIN_SRC shell
celery -A tasks worker --loglevel=info -B
celery -A settings worker -l info -B

#+END_SRC

#+BEGIN_SRC python :dir ~/git/celery-docker
from tasks import add
a = add.delay(1, 3)
a.status
a.result
a.state
#+END_SRC

#+RESULTS:

start celery and run with beat option.

#+BEGIN_SRC shell
celery -A tasks worker --loglevel=info -B
#+END_SRC


  #+BEGIN_SRC shell :dir ~/git/celery-docker :results output
    docker inspect celdb | grep IPAddress
  #+END_SRC

  #+RESULTS:
  :             "SecondaryIPAddresses": null,
  :             "IPAddress": "",
  :                     "IPAddress": "172.21.0.3",

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    \dt+
  #+END_SRC

  #+RESULTS:
  | List of relations |                            |       |          |            |             |
  |-------------------+----------------------------+-------+----------+------------+-------------|
  | Schema            | Name                       | Type  | Owner    | Size       | Description |
  | public            | auth_group                 | table | postgres | 0 bytes    |             |
  | public            | auth_group_permissions     | table | postgres | 0 bytes    |             |
  | public            | auth_permission            | table | postgres | 8192 bytes |             |
  | public            | auth_user                  | table | postgres | 8192 bytes |             |
  | public            | auth_user_groups           | table | postgres | 0 bytes    |             |
  | public            | auth_user_user_permissions | table | postgres | 0 bytes    |             |
  | public            | django_admin_log           | table | postgres | 8192 bytes |             |
  | public            | django_content_type        | table | postgres | 8192 bytes |             |
  | public            | django_migrations          | table | postgres | 16 kB      |             |
  | public            | django_session             | table | postgres | 8192 bytes |             |
  | public            | unitime_course             | table | postgres | 56 kB      |             |
  | public            | unitime_coursecode         | table | postgres | 8192 bytes |             |
  | public            | unitime_courseoffering     | table | postgres | 64 kB      |             |
  | public            | unitime_lecture            | table | postgres | 224 kB     |             |
  | public            | unitime_room               | table | postgres | 72 kB      |             |

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    \d unitime_course
  #+END_SRC


  #+RESULTS:
  | Table "public.unitime_course"                                                                                                                                                                  |                          |           |          |                                            |
  |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------+-----------+----------+--------------------------------------------|
  | Column                                                                                                                                                                                         | Type                     | Collation | Nullable | Default                                    |
  | id                                                                                                                                                                                             | integer                  |           | not null | nextval('unitime_course_id_seq'::regclass) |
  | created                                                                                                                                                                                        | timestamp with time zone |           | not null |                                            |
  | modified                                                                                                                                                                                       | timestamp with time zone |           | not null |                                            |
  | code                                                                                                                                                                                           | character varying(6)     |           | not null |                                            |
  | name                                                                                                                                                                                           | character varying(254)   |           | not null |                                            |
  | speed                                                                                                                                                                                          | character varying(20)    |           | not null |                                            |
  | points                                                                                                                                                                                         | character varying(20)    |           | not null |                                            |
  | syllabus                                                                                                                                                                                       | character varying(254)   |           | not null |                                            |
  | Indexes:                                                                                                                                                                                       |                          |           |          |                                            |
  | "unitime_course_pkey" PRIMARY KEY, btree (id)                                                                                                                                                  |                          |           |          |                                            |
  | Referenced by:                                                                                                                                                                                 |                          |           |          |                                            |
  | TABLE "unitime_courseoffering" CONSTRAINT "unitime_courseoffering_course_id_303916d0_fk_unitime_course_id" FOREIGN KEY (course_id) REFERENCES unitime_course(id) DEFERRABLE INITIALLY DEFERRED |                          |           |          |                                            |
  | TABLE "unitime_lecture" CONSTRAINT "unitime_lecture_course_id_6ddd41c6_fk_unitime_course_id" FOREIGN KEY (course_id) REFERENCES unitime_course(id) DEFERRABLE INITIALLY DEFERRED               |                          |           |          |                                            |

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.2 :dbuser postgres :database postgres
    \d unitime_lecture
  #+END_SRC

  #+RESULTS:


  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    -- SELECT * FROM unitime_course WHERE code='2DV50E';
    -- DROP TABLE IF EXISTS unitime_lecture CASCADE;
  #+END_SRC

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.4 :dbuser postgres :database postgres
    SELECT * FROM unitime_lecture WHERE unitime_lecture.course_id IN (SELECT id FROM unitime_course WHERE code='2DV50E');
  #+END_SRC

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    -- SELECT * FROM unitime_lecture WHERE unitime_lecture.course_id IN (SELECT id FROM unitime_course WHERE code='2DV50E') ORDER BY start_datetime;
    SELECT * FROM unitime_course WHERE code='1PE502';
  #+END_SRC

  #+RESULTS:
  | id | created | modified | code | name | speed | points | syllabus |
  |----+---------+----------+------+------+-------+--------+----------|


  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    -- SELECT * FROM unitime_lecture WHERE unitime_lecture.course_id IN (SELECT id FROM unitime_course WHERE code='2DV50E') ORDER BY start_datetime;
    SELECT * FROM unitime_lecture WHERE unitime_lecture.course_id IN (SELECT id FROM unitime_course WHERE code='1PE503') ORDER BY start_datetime;
  #+END_SRC

  #+RESULTS:
  | id | created | modified | start_datetime | end_datetime | teacher | description | course_id | course_offering_id | info | room_id |
  |----+---------+----------+----------------+--------------+---------+-------------+-----------+--------------------+------+---------|

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    SELECT * FROM unitime_lecture;
  #+END_SRC

  #+RESULTS:
  | id | created | modified | start_datetime | end_datetime | teacher | description | course_id | course_offering_id | info |
  |----+---------+----------+----------------+--------------+---------+-------------+-----------+--------------------+------|

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    SELECT count(*) FROM unitime_course;
  #+END_SRC

  #+RESULTS:
  | count |
  |-------|
  |  1657 |

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    SELECT count(*) FROM unitime_courseoffering;
  #+END_SRC

  #+RESULTS:
  | count |
  |-------|
  |  2045 |

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.3 :dbuser postgres :database postgres
    SELECT count(*) FROM unitime_lecture;
  #+END_SRC

  #+RESULTS:
  | count |
  |-------|
  | 13058 |

  #+BEGIN_SRC sql :engine postgresql :dbhost 172.21.0.4 :dbuser postgres :database postgres
    SELECT count(*) FROM unitime_room;
  #+END_SRC

  #+RESULTS:
  | count |
  |-------|
  |   524 |

  #+BEGIN_SRC shell
    python manage.py makemigrations
    python manage.py migrate
    time python manage.py shell <<EOF
    from unitime.tasks import get_courses_from_file, get_rooms_from_remote
    from unitime.tasks import get_courses_to_db, get_course_offerings_to_db
    from unitime.tasks import get_all_lectures
    get_courses_from_file()
    get_rooms_from_remote()
    get_courses_to_db()
    get_course_offerings_to_db()
    get_all_lectures()
    EOF
  #+END_SRC

* Initial handson stuff

  This is needed to do in the beginning. This will create the database layout and a
  superuser and import course codes.

  #+BEGIN_SRC shell
    python manage.py makemigrations
    python manage.py migrate
    python manage.py shell <<EOF
    from unitime.tasks import get_rooms_from_remote, get_courses_to_db
    from unitime.tasks import get_course_offerings_to_db, get_all_lectures
    get_rooms_from_remote()
    get_courses_to_db()
    get_course_offerings_to_db()
    get_all_lectures()
    EOF
  #+END_SRC

  TODO: write custom manage.py commands for this: https://docs.djangoproject.com/en/2.0/howto/custom-management-commands/

* Database model

  E/R diagram for the database.


  [[./project/unitime-api-er-diagram.png]]


* Room

  N2037, is found 2 times
  N2037	  2	56.853519	14.832632
  N2037	  2	56.668678	16.350328
